<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Notes</title>
    <link rel="stylesheet" href="/styles/styles.css">
    <script src="https://kit.fontawesome.com/6c117c7d34.js" crossorigin="anonymous"></script>
    <script src="/js/scripts.js" defer></script>
</head>
<body>
<%- include ('../partials/navloggedin') -%>
<div class="library-sort"><h6>Filter:</h6>
<select id="subSort" name="subSort">
    <option value="season">Season</option>
    <option value="spring">Spring</option>
    <option value="summer">Summer</option>
    <option value="fall">Fall</option>
    <option value="winter">Winter</option>
</select>
<h6><a href="/library">List View</a></h6>
</div>
        <div id="map2"></div>
<script src="<%= mapsAPI %>" async ></script>
<!-- <script>
    let map, marker;
    let data = <%- JSON.stringify(data) %>;
    let allMarkers;
    function initMap() {
        if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition((position) => {
                // current location of the user
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                } 
        // Set static latitude, longitude value
        const latlng = new google.maps.LatLng(currentPosition);
        // Set map options
        const myOptions = {
        zoom: 10,
        center: latlng
        }
        map = new google.maps.Map(document.getElementById('map2'), {zoom: 10, center: latlng});
            function displayMarkers() {
            for (log of data) {
                console.log(log)
            if (log.latitude && log.longitude) {
            log.latitude = Number(log.latitude);
            log.longitude = Number(log.longitude);
            const object = {lat: log.latitude, lng: log.longitude};
            marker = new google.maps.Marker({position: object, map: map});

            }
        } 
        }
        displayMarkers();
        })
    }
    }

        </script> -->
        <script>
            let latitudeArray = [];
            let longitudeArray = [];
            let nameArray = []
            let dateArray = []
            let id_Array = []
            let locations = []
            let data = <%- JSON.stringify(data) %>;

        for (log of data) {
            if (log.latitude && log.longitude) {
            latitudeArray.push(log.latitude)
            longitudeArray.push(log.longitude)
            nameArray.push(log.id_name)
            dateArray.push(log.date)
            id_Array.push(log._id)
        }
    }

        for (let i = 0; i < latitudeArray.length; i++) {
            let subArray = [];
            subArray.push(latitudeArray[i], longitudeArray[i])
            locations.push(subArray);
        }
        
    console.log(locations)
    console.log(latitudeArray)
    console.log(longitudeArray)
    console.log(nameArray)
    console.log(id_Array)
    console.log(dateArray)
      
        function initMap() {
            if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
            // current location of the user
            currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            }


        let userCurrentlatlng = new google.maps.LatLng(currentPosition);
        
        const myOptions = {
            center: userCurrentlatlng,
            zoom: 10,
            streetViewControl: false,
            mapTypeControl: false,
          };
          const map = new google.maps.Map(document.getElementById("map2"),
              myOptions);
      
          setMarkers(map,locations)
        })
    }
      
      
      
        function setMarkers(map,locations){
      
        let marker, i;
      
      for (i = 0; i < locations.length; i++)
       {  
       
       const lat = latitudeArray[i]
       const long = longitudeArray[i]
      
       latlngset = new google.maps.LatLng(lat, long);
      
        marker = new google.maps.Marker({  
                map: map, position: latlngset  
              });
        
        let year = dateArray[i].slice(0,4);
        let month = dateArray[i].slice(5,7);
        let day = dateArray[i].slice(8,10)
        let date = `${month}/${day}/${year}`
      
      let content = 
      `<h4>Name: ${nameArray[i]}</h4><h4>Date: ${date} </h4><h4><a style="color: black; text-decoration: underline" href="/library/${id_Array[i]}">Details</a></h4>`
    
    
        const infowindow = new google.maps.InfoWindow()
      
      google.maps.event.addListener(marker,'click', (function(marker,content,infowindow){ 
              return function() {
                 infowindow.setContent(content);
                 infowindow.open(map,marker);
              };
          })(marker,content,infowindow)); 
      
        }
        }
}
        </script>
</body>
</html>